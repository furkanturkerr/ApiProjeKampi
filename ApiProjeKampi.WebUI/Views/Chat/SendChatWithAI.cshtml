@{
ViewData["Title"] = "AI Chat";
Layout = "~/Views/AdminLayout/Index.cshtml";
}

<style>
    .section { padding: 0 !important; margin: 0 !important; }
    .section-body { padding: 0 !important; margin: 0 !important; }

    @@keyframes bounce {
        0%, 60%, 100% { transform: translateY(0); }
        30%            { transform: translateY(-5px); }
    }
    #chat::-webkit-scrollbar { width: 4px; }
    #chat::-webkit-scrollbar-thumb { background: #d0d9ff; border-radius: 10px; }
    #inputWrapper:focus-within { border-color: #6777ef !important; }
</style>

<section class="section">
    <div class="section-body">
        <div style="display:flex; flex-direction:column; height:calc(100vh - 62px);">

            <!-- â”€â”€ Header â”€â”€ -->
            <div style="background:linear-gradient(135deg,#6777ef,#4a5dd4); padding:14px 24px; flex-shrink:0;">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-robot text-white" style="font-size:1.2rem;"></i>
                        </div>
                        <div>
                            <div style="color:#fff;font-weight:700;font-size:1rem;">Yummy AI Asistan</div>
                            <div style="display:flex;align-items:center;gap:6px;margin-top:2px;">
                                <span style="width:7px;height:7px;border-radius:50%;background:#4ade80;display:inline-block;"></span>
                                <span style="color:rgba(255,255,255,0.85);font-size:0.76rem;">Ã‡evrimiÃ§i Â· Yemek & Restoran UzmanÄ±</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="clearChat()"
                            style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:#fff;border-radius:8px;padding:7px 16px;font-size:0.82rem;cursor:pointer;"
                            onmouseover="this.style.background='rgba(255,255,255,0.28)'"
                            onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                        <i class="fas fa-trash mr-1"></i> Temizle
                    </button>
                </div>
            </div>

            <!-- â”€â”€ HÄ±zlÄ± Sorular â”€â”€ -->
            <div style="padding:9px 20px;background:#f0f3ff;border-bottom:1px solid #e3e8fd;flex-shrink:0;">
                <div style="display:flex;align-items:center;flex-wrap:wrap;gap:7px;">
                    <small style="color:#6c757d;font-weight:600;white-space:nowrap;font-size:0.76rem;">HÄ±zlÄ± Sor:</small>
                    <span class="qs" onclick="quickSend('BugÃ¼n iÃ§in menÃ¼ Ã¶nerisi verir misin?')">ğŸ“‹ MenÃ¼ Ã–nerisi</span>
                    <span class="qs" onclick="quickSend('MÃ¼ÅŸteri memnuniyetini artÄ±rmak iÃ§in Ã¶neriler nelerdir?')">â­ MÃ¼ÅŸteri Memnuniyeti</span>
                    <span class="qs" onclick="quickSend('Sezonluk malzemelerle ne yapabilirim?')">ğŸŒ¿ Sezonluk Tarif</span>
                    <span class="qs" onclick="quickSend('Restoran iÃ§in maliyet dÃ¼ÅŸÃ¼rme Ã¶nerileri verir misin?')">ğŸ’° Maliyet Optimizasyonu</span>
                </div>
            </div>

            <style>
                .qs {
                    background:#fff;border:1px solid #d0d9ff;color:#6777ef;
                    border-radius:20px;padding:4px 13px;font-size:0.77rem;
                    cursor:pointer;transition:all 0.15s;
                }
                .qs:hover { background:#6777ef; color:#fff; }
            </style>

            <!-- â”€â”€ Mesaj AlanÄ± â”€â”€ -->
            <div id="chat" style="flex:1;overflow-y:auto;padding:20px 24px;background:#fafbff;display:flex;flex-direction:column;gap:8px;">

                <!-- KarÅŸÄ±lama -->
                <div style="display:flex;align-items:flex-start;gap:10px;" id="welcomeMsg">
                    <div style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#6777ef,#4a5dd4);display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;">
                        <i class="fas fa-robot text-white" style="font-size:0.8rem;"></i>
                    </div>
                    <div>
                        <div style="background:#fff;border:1px solid #e8eafd;border-radius:4px 14px 14px 14px;padding:12px 16px;max-width:520px;box-shadow:0 1px 6px rgba(103,119,239,0.08);font-size:0.9rem;line-height:1.65;color:#374151;">
                            Merhaba! Ben <strong>Yummy AI AsistanÄ±</strong> ğŸ‘‹<br/>
                            Yemek tarifleri, menÃ¼ Ã¶nerileri veya restoran yÃ¶netimi konularÄ±nda yardÄ±mcÄ± olabilirim.<br/>
                            <span style="color:#6777ef;">NasÄ±l yardÄ±mcÄ± olabilirim?</span>
                        </div>
                        <div style="font-size:0.68rem;color:#9ca3af;margin-top:3px;margin-left:4px;">Yummy AI</div>
                    </div>
                </div>

            </div>

            <!-- â”€â”€ Typing â”€â”€ -->
            <div id="typing" style="display:none;padding:8px 24px;background:#fafbff;border-top:1px solid #eef0ff;flex-shrink:0;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#6777ef,#4a5dd4);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <i class="fas fa-robot text-white" style="font-size:0.72rem;"></i>
                    </div>
                    <div style="background:#fff;border:1px solid #e8eafd;border-radius:4px 14px 14px 14px;padding:9px 14px;display:flex;gap:5px;align-items:center;">
                        <span style="width:6px;height:6px;border-radius:50%;background:#6777ef;display:inline-block;animation:bounce 1.1s infinite 0s;"></span>
                        <span style="width:6px;height:6px;border-radius:50%;background:#6777ef;display:inline-block;animation:bounce 1.1s infinite 0.18s;"></span>
                        <span style="width:6px;height:6px;border-radius:50%;background:#6777ef;display:inline-block;animation:bounce 1.1s infinite 0.36s;"></span>
                    </div>
                </div>
            </div>

            <!-- â”€â”€ Input â”€â”€ -->
            <div style="padding:12px 20px;background:#fff;border-top:1px solid #eef0ff;flex-shrink:0;">
                <div id="inputWrapper"
                     style="display:flex;align-items:center;gap:10px;background:#f4f5ff;border:1.5px solid #e3e8fd;border-radius:28px;padding:5px 5px 5px 18px;transition:border-color 0.2s;">
                    <input id="messageInput" type="text" placeholder="Bir ÅŸeyler sorun..."
                           style="flex:1;border:none;background:transparent;outline:none;font-size:0.9rem;color:#374151;padding:4px 0;" />
                    <button id="sendBtn"
                            style="width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#6777ef,#4a5dd4);border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 3px 10px rgba(103,119,239,0.35);transition:transform 0.15s;flex-shrink:0;"
                            onmouseover="this.style.transform='scale(1.08)'"
                            onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-paper-plane" style="font-size:0.88rem;margin-left:2px;"></i>
                    </button>
                </div>
                <div style="text-align:center;margin-top:6px;">
                    <small style="font-size:0.68rem;color:#9ca3af;">
                        <i class="fas fa-shield-alt mr-1"></i>
                        AI yanÄ±tlarÄ± bilgi amaÃ§lÄ±dÄ±r Â· Enter ile de gÃ¶nderebilirsiniz
                    </small>
                </div>
            </div>

        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@@8.0.0/dist/browser/signalr.min.js"></script>
<script>
    const chat    = document.getElementById('chat');
    const typing  = document.getElementById('typing');
    const input   = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    let bufEl = null;

    function now() {
        return new Date().toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit' });
    }

    function escapeHtml(t) {
        return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function appendUserMessage(text) {
        const d = document.createElement('div');
        d.style.cssText = 'display:flex;justify-content:flex-end;';
        d.innerHTML = `
            <div>
                <div style="background:linear-gradient(135deg,#6777ef,#4a5dd4);color:#fff;border-radius:14px 4px 14px 14px;padding:10px 16px;max-width:460px;font-size:0.9rem;line-height:1.55;box-shadow:0 2px 10px rgba(103,119,239,0.22);display:inline-block;">
                    ${escapeHtml(text)}
                </div>
                <div style="font-size:0.68rem;color:#9ca3af;margin-top:3px;text-align:right;margin-right:2px;">Siz Â· ${now()}</div>
            </div>`;
        chat.appendChild(d);
        chat.scrollTop = chat.scrollHeight;
    }

    function createAIBubble() {
        const d = document.createElement('div');
        d.style.cssText = 'display:flex;align-items:flex-start;gap:10px;';
        d.innerHTML = `
            <div style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#6777ef,#4a5dd4);display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;">
                <i class="fas fa-robot text-white" style="font-size:0.8rem;"></i>
            </div>
            <div>
                <div class="aib" style="background:#fff;border:1px solid #e8eafd;border-radius:4px 14px 14px 14px;padding:12px 16px;max-width:600px;font-size:0.9rem;line-height:1.65;color:#374151;box-shadow:0 1px 6px rgba(103,119,239,0.08);white-space:pre-wrap;"></div>
                <div style="font-size:0.68rem;color:#9ca3af;margin-top:3px;margin-left:2px;">Yummy AI Â· ${now()}</div>
            </div>`;
        chat.appendChild(d);
        return d.querySelector('.aib');
    }

    async function quickSend(text) {
        input.value = text;
        await send();
    }

    const conn = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .withAutomaticReconnect()
        .build();

    // KullanÄ±cÄ± mesajÄ± gelince typing'i GÄ°ZLE
    conn.on("ReceiveUserEcho", (text) => {
        typing.style.display = 'none';
        appendUserMessage(text);
    });

    // Ä°lk token gelince typing'i gÃ¶ster ve balonu oluÅŸtur
    conn.on("ReceiveToken", (token) => {
        typing.style.display = 'none'; // typing gizle, yerine balon geldi
        if (!bufEl) {
            bufEl = createAIBubble();
        }
        bufEl.textContent += token;
        chat.scrollTop = chat.scrollHeight;
    });

    conn.on("CompleteMessage", () => {
        typing.style.display = 'none';
        bufEl = null;
        chat.scrollTop = chat.scrollHeight;
    });

    async function start() {
        try { await conn.start(); }
        catch (e) { console.error(e); setTimeout(start, 1500); }
    }
    start();

    async function send() {
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        bufEl = null;
        // Mesaj gÃ¶nderince typing'i gÃ¶ster (AI cevap verene kadar)
        typing.style.display = 'block';
        chat.scrollTop = chat.scrollHeight;
        await conn.invoke("SendMessage", text);
    }

    function clearChat() {
        if (!confirm('Sohbet geÃ§miÅŸi temizlensin mi?')) return;
        const welcome = document.getElementById('welcomeMsg');
        chat.innerHTML = '';
        if (welcome) chat.appendChild(welcome);
        bufEl = null;
        typing.style.display = 'none';
    }

    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });
</script>